<?php

namespace App\Http\Controllers\frontend;

use App\Http\Controllers\Controller;
use App\Http\Requests\BookRequest;
use App\Models\Book;
use App\Models\Booking_details;
use App\Models\City;
use App\Models\Coupon;
use App\Models\Payment;
use App\Models\Service;
use App\Models\Shipping;
use App\Models\User;
use Carbon\Carbon;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Date;

class ServiceNoFixedController extends Controller
{
    /**
     * Display a listing of the resource.
     *
     * @return \Illuminate\Http\Response
     */
    public function index()
    {
        $service = Service::find(1);
        return view('frontend.service.ca-le')->with(compact('service'));

    }

    /**
     * Show the form for creating a new resource.
     *
     * @return \Illuminate\Http\Response
     */
    public function create()
    {
        $today = Carbon::now()->format('l,d-m-Y');
        $id= Auth::id();
        $user = User::findOrFail($id);

        $city = City::all();
        $payment = Payment::all();
        $coupon = Coupon::all();

        //get shipping info
        $shipping = Shipping::where('user_id', $user->user_id)->first();
        $service = Service::find(1);

        return view('frontend.booking.appointment')->with(compact('today','shipping','payment','coupon','service'));
    }

    /**
     * Store a newly created resource in storage.
     *
     * @param  \Illuminate\Http\Request  $request
     * @return \Illuminate\Http\Response
     */
    public function check_Booking(Request $request){
        $data = $request->all();
        // dd($data);
        $book_time_start = $request->book_time_start;
        $book_time_number = $request->book_time_number;
        $book_price = $request->book_price;
        $klcv = $request->Klcv;
        $book_notes = $request->book_notes;
        $service_id = $request->service_id;
        //change m-d-y
        // dd($data['book_date']);
        $changedate = explode("/",$data['book_date']);
        $data['book_date'] = $changedate[1].'/'.$changedate[0].'/'.$changedate[2];
        // dd($data);
        $timestamp = strtotime($data['book_date']);
        $book_date = date('l,d/m/Y',$timestamp);
        // get day
        $getday = date('l',$timestamp);
        if($getday == "Sunday" || $getday =="Saturday"){
            $book_price = $book_price+10000;
        }

        $output = '';
        $id= Auth::id();
        $user = User::findOrFail($id);
        $shipping = Shipping::where('user_id', $user->user_id)->first();

        $payment = Payment::all();
        $coupon = Coupon::all();
        $price_add = 0;
        $data['book_options'] = $request->book_options;
        if($data['book_options']){
            foreach ($data['book_options'] as $key => $value) {
                if ($value == "Mang dụng cụ") {
                    $price_add = 30000;
                }
            }
            $data['book_options']=implode(",",$data['book_options']);
        }

        // if($coupon == true){
        //     $coupon_number = $coupon->coupon_number;
        //     if($coupon->coupon_method == 0){
        //         $method = '%';
        //     }else{
        //         $method = 'đ';
        //     }
        // }else{
        //     $coupon_number = '';
        //     $method = '';
        // }
        $price = 80000;
        $split_time = explode(":",$book_time_start);
        $time_end = $split_time[0]+$book_time_number .':'.$split_time[1];
        $output.='<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="bg-white modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Xác nhận và thanh toán</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body" style="color: #000;">

                        <div class="row g-3">
                        <h5 class="modal-title">Vị trí làm việc</h5>
                        <div class="col-sm-12" style="    border: 1px solid #ccc;border-radius: 5px;padding: 20px;">
                        <p style="font-weight: 600">'.$shipping->shipping_name.'</p>
                        <p> Số điện thoại: (+84)  '.$shipping->shipping_phone.'</p>
                        <p> '.$shipping->shipping_address.'</p>
                            <p><a href="'.route('home.checkout').'" class="btn btn-success" style="float: right">Thay đổi</a></p>
                        </div>
                        <h5 class="modal-title">Thông tin công việc</h5>
                        <div class="col-sm-12" style="    border: 1px solid #ccc; border-radius: 5px; padding: 20px;">
                            <p style="font-weight: 600">Thời gian làm việc</p>
                            <div style="display: flex; justify-content: space-between">
                                <label for="">Ngày làm việc</label>
                                <p class="check-date">'.$book_date.' - '.$book_time_start.'</p>
                            </div>
                            <div style="display: flex; justify-content: space-between">
                                <label for="">Làm trong</label>
                                <p class="check-time">'.$book_time_number.' giờ, '.$book_time_start.' đến '.$time_end.'</p>
                            </div>

                            <p style="font-weight: 600">Chi tiết công việc</p>
                            <div style="display: flex; justify-content: space-between">
                                <label for="">Khối lượng công việc</label>
                                <p class="check-g">'.$klcv.'</p>
                            </div>
                            <div style="display: flex; justify-content: space-between">
                                <label for="">Dịch vụ thêm</label>
                                <input type="hidden" name"book_optionss" value="'.$data['book_options'].'">
                                <p id="options" class="check-options">'.$data['book_options'].'</p>
                            </div>

                            <div style="display: flex; justify-content: space-between">
                                <label for="">Ghi chú cho người làm</label>
                                <p class="check-notes">'.$book_notes.'</p>
                            </div>
                            <div style="display: flex; justify-content: space-between">
                                <div class="col-sm-6">
                                    <h5 class="modal-title">Phương thức thanh toán</h5>
                                </div>
                                <div class="col-sm-6">
                                    <h5 class="modal-title">Khuyễn mãi</h5>
                                </div>
                            </div>

                            <div style="display: flex; justify-content: space-between">
                                <div class="col-sm-6">
                                <select class="form-select border-0" style="height: 55px;" name="payment_id">';
                                foreach ($payment as $key => $valP) {
                                    $output .=' <option value="'.$valP->payment_id.'">'.$valP->payment_method.'</option>';
                                }
                                 $output .='
                                </select>
                                </div>
                                <div class="col-sm-6">
                                <select class="form-select border-0" id="coupon" style="height: 55px;" name="coupon_id">
                            <option selected  value="0,0,0">Khuyễn mãi</option>';
                            foreach ($coupon as $key => $valC) {
                                $time_end = date('d/m/Y',strtotime($valC->coupon_time_end));
                                $today = date('d/m/Y',strtotime(now()));
                                $output .=' <option value="'. $valC->coupon_id .','. $valC->coupon_method .','. $valC->coupon_number .'" ';
                                if ( ($time_end <= $today)) {
                                    $output.='disabled style="color: red"';
                                }
                                $output.='>'. $valC->coupon_name.'</option>';
                            }
                             $output .='

                        </select>
                                </div>
                            </div>
                        </div>

                        <div style="display: flex; justify-content: space-between">
                            <h4 class="modal-title">Tổng Cộng</h4>
                            <h4 class="modal-title book-total">'.number_format($book_time_number* $book_price +$price_add).'đ</h4>
                            <input type="hidden" name="book_total" value="'.$book_time_number* $book_price +$price_add.'">
                        </div>

                        <div class="modal-footer">
                            <button type="submit" class="btn btn-orange w-100 py-3">Đặt lịch</button>
                        </div>
                    </div>
                </div>
            </div>';
        echo $output;
    }


    public function store(Request $request){

        $data = $request->all();
        $id= Auth::id();
        $user = User::findOrFail($id);
        $shipping = Shipping::where('user_id', $user->user_id)->first();
        $book_id = substr(md5(microtime()),rand(0,26),5);
        $book_options = $request->list_options;

        $coupon_id = explode(',',$data['coupon_id']);
        $book_total =$data['book_total'];
        $total_coupon = 0;
        $coupon = Coupon::find($coupon_id[0]);
        if($coupon){
            if ($coupon->coupon_method == 0) {
                $total_coupon = $book_total*$coupon->coupon_number/100;
            }else{
                $total_coupon = $coupon->coupon_number;
            }
        };
        $book_total = $book_total - $total_coupon;


        $booking = [
            'book_id'=>$book_id,
            'service_id'=>$data['service_id'],
            'shipping_id'=> $shipping->shipping_id,
            'book_total'=>$book_total,
            'book_status'=>1,
            'book_address'=>$shipping->shipping_address,
            'book_notes'=>$data['book_notes'],
        ];
        // dd($data);


        $booking = Book::create($booking);
        // $booking = Book::find(1);
        // dd($booking);

        if($booking){

            $booking_details = [
                'book_id'=>$booking->book_id,
                'coupon_id'=>$coupon_id[0],
                'payment_id'=>$data['payment_id'],
                'book_date'=>$data['book_date'],
                'book_time_start'=>$data['book_time_start'],
                'book_time_number'=>$data['book_time_number'],
                'book_total'=>$booking->book_total,
                'book_options'=> $book_options,
            ];
            // dd($booking_details);

            $bookdetail = Booking_details::create($booking_details);

            $msg = 'Đặt lịch thành công';
            $style = 'success';

        }else{


            $msg = 'Có lỗi xảy ra khi đặt lịch! Vui lòng kiểm tra lại.';
            $style = 'danger';

        }

        return redirect()->back()->with(compact('msg','style'));
        }

    // public function store(BookRequest $request)
    // {
    //     $data = $request->all();
    //     $id= Auth::id();
    //     $user = User::findOrFail($id);
    //     $shipping = Shipping::where('user_id', $user->user_id)->first();
    //     $book_id = substr(md5(microtime()),rand(0,26),5);
    //     $coupon_id = explode(',',$data['coupon_id']);


    //     // dd($data);
    //     $booking = [
    //         'book_id'=>$book_id,
    //         'service_id'=>$data['service_id'],
    //         'shipping_id'=> $shipping->shipping_id,
    //         'book_total'=>$data['book_total'],
    //         'book_status'=>1,
    //         'book_address'=>$shipping->shipping_address,
    //         'book_notes'=>$data['book_notes'],
    //     ];

    //     // $booking = Book::create($booking);
    //     $booking = Book::find(1);
    //     // dd($booking);

    //     if($booking){
    //         if ($data['options']) {
    //             $data['options'] =implode(",",$data['options']);
    //         }
    //         $booking_details = [
    //             'book_id'=>$booking->book_id,
    //             'coupon_id'=>$coupon_id[0],
    //             'payment_id'=>$data['payment_id'],
    //             'book_date'=>$data['book_date'],
    //             'book_time_start'=>$data['book_time_start'],
    //             'book_time_number'=>$data['book_time_number'],
    //             'book_total'=>$data['book_total'],
    //             'book_options'=> $data['options'],
    //         ];
    //         // dd($booking_details);

    //         $bookdetail = Booking_details::create($booking_details);

    //         $msg = 'Đặt lịch thành công';
    //         $style = 'success';

    //     }else{


    //         $msg = 'Có lỗi xảy ra khi đặt lịch! Vui lòng kiểm tra lại.';
    //         $style = 'danger';

    //     }

    //     return redirect()->back()->with(compact('msg','style'));


    // }

    /**
     * Display the specified resource.
     *
     * @param  int  $id
     * @return \Illuminate\Http\Response
     */
    public function show($id)
    {
        //
    }

    /**
     * Show the form for editing the specified resource.
     *
     * @param  int  $id
     * @return \Illuminate\Http\Response
     */
    public function edit($id)
    {
        //
    }

    /**
     * Update the specified resource in storage.
     *
     * @param  \Illuminate\Http\Request  $request
     * @param  int  $id
     * @return \Illuminate\Http\Response
     */
    public function update(Request $request, $id)
    {
        //
    }

    /**
     * Remove the specified resource from storage.
     *
     * @param  int  $id
     * @return \Illuminate\Http\Response
     */
    public function destroy($id)
    {
        //
    }
}
